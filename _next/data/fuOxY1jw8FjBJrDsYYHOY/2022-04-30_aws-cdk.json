{"pageProps":{"post":{"slug":"2022-04-30_aws-cdk","title":"aws-cdkでNext.jsを動かすためのECS環境を構築したメモ","publishDate":"2022-04-30","coverImage":"","excerpt":"AWS なんもわからん状態はまずいなと思い、最近話題の aws-cdk を使って Next.js のコンテナを AWS ECS(on Fargate)上にデプロイしてみた。","ogImage":{"url":"https://raw.githubusercontent.com/YTakahashii/blog/main/public/assets/blog/2022-04-30_aws-cdk/ogimage.png"},"content":"<p>AWS なんもわからん状態はまずいなと思い、最近話題の aws-cdk を使って Next.js のコンテナを AWS ECS(on Fargate)上にデプロイしてみた。\n備忘録として過程をメモっておく。</p>\n<h2>aws-cdk とは</h2>\n<ul>\n<li>AWS のクラウドインフラストラクチャをコードとして定義できる</li>\n<li>定義したコードをもとに AWS CloudFormation を通じてインフラをデプロイ（リソース作成）することができる</li>\n</ul>\n<h2>やったことログ</h2>\n<h3>Dockerfile の作成と ECR への push</h3>\n<p>公式に Docker Image のサンプルがあるのでそのまま使った。</p>\n<p>experimental の <code>outputStandalone</code> を有効にすると、production 環境に必要なファイルのみをコピーした <code>.next/standalone</code> が作成される。</p>\n<ul>\n<li><a href=\"https://nextjs.org/docs/deployment#docker-image\">Deployment | Next.js</a></li>\n<li><a href=\"https://nextjs.org/docs/advanced-features/output-file-tracing#automatically-copying-traced-files-experimental\">Output File Tracing | Next.js</a></li>\n</ul>\n<h3>CloudFormation</h3>\n<p><a href=\"https://dev.classmethod.jp/articles/cloudformation-beginner01/\">【CloudFormation 入門】5 分と 6 行で始める AWS CloudFormation テンプレートによるインフラ構築 | DevelopersIO</a> を読んで CloudFormation の概要をを頭に入れて用語を整理した。</p>\n<ul>\n<li>テンプレート：yaml or json で記述するインフラ定義のファイル</li>\n<li>スタック：テンプレートから作成/破棄をまとめて実行するリソースの集合\n<ul>\n<li>1 つのスタック内に VPC, EC2, S3, RDS などのプロダクトを 1 つ動かすために必要なリソースをまとめて定義するｋとができる</li>\n</ul>\n</li>\n</ul>\n<h3>aws-cdk インフラを構築</h3>\n<h4>セットアップ</h4>\n<pre class=\"shiki\" style=\"background-color: #24292e\"><code><span class=\"line\"><span style=\"color: #E1E4E8\">$ npm i -g aws-cdk</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">cdk init app --language=typescript</span></span>\n<span class=\"line\"></span></code></pre>\n<h4>CdkStack を定義する</h4>\n<p>ECS を動かすための最小限の Stack を定義した。</p>\n<pre class=\"shiki\" style=\"background-color: #24292e\"><code><span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { Stack, StackProps } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { Construct } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'constructs'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { Role, ServicePrincipal } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib/aws-iam'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { TaskDefinition, Compatibility, ContainerImage, AwsLogDriver, Protocol, Cluster } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib/aws-ecs'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { Vpc } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib/aws-ec2'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { Repository } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib/aws-ecr'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color: #F97583\">import</span><span style=\"color: #E1E4E8\"> { ApplicationLoadBalancedFargateService } </span><span style=\"color: #F97583\">from</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #9ECBFF\">'aws-cdk-lib/aws-ecs-patterns'</span><span style=\"color: #E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F97583\">export</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">defaultProps</span><span style=\"color: #F97583\">:</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">StackProps</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">  env: {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    region: </span><span style=\"color: #9ECBFF\">'ap-northeast-1'</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    account: process.env.</span><span style=\"color: #79B8FF\">AWS_ACCOUNT</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F97583\">export</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">class</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">CdkStack</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">extends</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">Stack</span><span style=\"color: #E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">  </span><span style=\"color: #F97583\">constructor</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #FFAB70\">scope</span><span style=\"color: #F97583\">:</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">Construct</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #FFAB70\">id</span><span style=\"color: #F97583\">:</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">string</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #FFAB70\">props</span><span style=\"color: #F97583\">?:</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">StackProps</span><span style=\"color: #E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #79B8FF\">super</span><span style=\"color: #E1E4E8\">(scope, id, props);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">taskRole</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">Role</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'ecs-task-role'</span><span style=\"color: #E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      assumedBy: </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">ServicePrincipal</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #9ECBFF\">'ecs-tasks.amazonaws.com'</span><span style=\"color: #E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">taskDefinition</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">TaskDefinition</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'ecs-task-definition'</span><span style=\"color: #E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      taskRole,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      executionRole: taskRole,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      compatibility: Compatibility.</span><span style=\"color: #79B8FF\">FARGATE</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      cpu: </span><span style=\"color: #9ECBFF\">'512'</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      memoryMiB: </span><span style=\"color: #9ECBFF\">'1024'</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">repository</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> Repository.</span><span style=\"color: #B392F0\">fromRepositoryArn</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'repo'</span><span style=\"color: #E1E4E8\">, process.env.</span><span style=\"color: #79B8FF\">ECR_ARN</span><span style=\"color: #E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">container</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> taskDefinition.</span><span style=\"color: #B392F0\">addContainer</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #9ECBFF\">'ecs-task-container'</span><span style=\"color: #E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      image: ContainerImage.</span><span style=\"color: #B392F0\">fromEcrRepository</span><span style=\"color: #E1E4E8\">(repository),</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      logging: </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">AwsLogDriver</span><span style=\"color: #E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">        streamPrefix: </span><span style=\"color: #9ECBFF\">'ecs-task-log-prefix'</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      }),</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    container.</span><span style=\"color: #B392F0\">addPortMappings</span><span style=\"color: #E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      containerPort: </span><span style=\"color: #79B8FF\">3000</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      hostPort: </span><span style=\"color: #79B8FF\">3000</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      protocol: Protocol.</span><span style=\"color: #79B8FF\">TCP</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">vpc</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">Vpc</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'ecs-task-vpc'</span><span style=\"color: #E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      maxAzs: </span><span style=\"color: #79B8FF\">2</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      natGateways: </span><span style=\"color: #79B8FF\">1</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">const</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #79B8FF\">cluster</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">=</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">Cluster</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'ecs-task-cluster'</span><span style=\"color: #E1E4E8\">, { vpc });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    </span><span style=\"color: #F97583\">new</span><span style=\"color: #E1E4E8\"> </span><span style=\"color: #B392F0\">ApplicationLoadBalancedFargateService</span><span style=\"color: #E1E4E8\">(</span><span style=\"color: #79B8FF\">this</span><span style=\"color: #E1E4E8\">, </span><span style=\"color: #9ECBFF\">'FargateService'</span><span style=\"color: #E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      cluster,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      cpu: </span><span style=\"color: #79B8FF\">512</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      desiredCount: </span><span style=\"color: #79B8FF\">2</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      taskDefinition,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      memoryLimitMiB: </span><span style=\"color: #79B8FF\">512</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">      publicLoadBalancer: </span><span style=\"color: #79B8FF\">true</span><span style=\"color: #E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<h4>デプロイ</h4>\n<p>以下を実行するとインフラが構築できた。</p>\n<pre class=\"shiki\" style=\"background-color: #24292e\"><code><span class=\"line\"><span style=\"color: #E1E4E8\">$ yarn build</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">$ yarn cdk bootstrap</span></span>\n<span class=\"line\"><span style=\"color: #E1E4E8\">$ yarn cdk deploy</span></span>\n<span class=\"line\"></span></code></pre>\n<h2>感想</h2>\n<ul>\n<li>CloudFormation だとクソ長 yaml を書くのがしんどそうだったが、cdk だと TypeScript で数十行でかけたので開発体験が良かった</li>\n<li>AWS コンソールでポチポチ設定したことがあるが、それと比較すると、どのリソースをどのように使うのかを cdk だと明確に書けるので AWS への理解が深まった。コードなのであとから見返すこともできて良い。</li>\n</ul>\n<h2>参考</h2>\n<ul>\n<li><a href=\"https://aws.amazon.com/jp/cdk/faqs\">AWS クラウド開発のよくある質問</a></li>\n<li><a href=\"https://dev.classmethod.jp/articles/cloudformation-beginner01/\">【CloudFormation 入門】5 分と 6 行で始める AWS CloudFormation テンプレートによるインフラ構築 | DevelopersIO</a></li>\n<li><a href=\"https://dev.classmethod.jp/articles/aws-cdk-command-line-interface/\">cdk コマンドの機能を 実際に叩いて理解する 【 AWS CDK Command Line Interface 】 | DevelopersIO</a></li>\n<li><a href=\"https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html\">https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html</a></li>\n</ul>","url":"https://ytakahashii.github.io/blog/2022-04-30_aws-cdk","isPrivate":false}},"__N_SSG":true}